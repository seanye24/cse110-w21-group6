<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: scripts/taskList.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: scripts/taskList.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Manage tasklist for page
 */

/**
 * A task object containing a name and pomodoros stats
 * @typedef {Object} Task
 * @property {string} name                - name of the task
 * @property {number} usedPomodoros       - pomodoros used so far
 * @property {number} estimatedPomodoros  - estimated number of pomos needed
 * @property {boolean} selected           - whether task is selected
 * @property {boolean} completed          - whether task is completed
 */

import { createElement } from '../utils/helpers';
import { validateTask } from '../utils/taskList';

let tasks = [];
let taskList;
let taskListContainer;
let taskListItemContainer;
let taskItemForm;
let taskItemFormContainer;
let taskItemFormInputs;

/**
 * Save current tasks to localStorage
 */
const saveTasks = () => {
  window.localStorage.setItem('tasks', JSON.stringify(tasks));
};

/**
 * Retrieve task from tasks and DOM
 * @param {Task} task - task
 * @return {{taskIndex: number, taskElement: HTMLElement}}
 */
const getTask = ({ name }) => ({
  taskIndex: tasks.findIndex((task) => task.name === name),
  taskElement: taskListItemContainer.querySelector(`[name="${name}"]`),
});

/**
 * Get button elements from task-item element
 * @param {HTMLElement} taskElement - task-item element
 * @return {{delete: HTMLButtonElement}} - button elements object
 */
const getTaskItemButtons = (taskElement) => {
  const buttons = Array.from(
    taskElement.shadowRoot.querySelectorAll('.task-button'),
  );

  return {
    delete: buttons.find((btn) => btn.getAttribute('id') === 'delete-button'),
  };
};

/**
 * Add task object to DOM, add event listeners to task-item
 * @param {HTMLElement} newTaskElement - new task element to be added
 * @param {'start' | 'end' | HTMLElement} position - position in list to append
 * @return {HTMLElement} - new task element added to DOM
 */
const addTaskToDom = (newTaskElement, position = 'end') => {
  if (position !== 'end' &amp;&amp; position !== 'start') {
    const { taskElement } = getTask(position);
    taskElement.before(newTaskElement);
  } else if (position === 'end') {
    taskListItemContainer.append(newTaskElement);
  } else if (position === 'start') {
    taskListItemContainer.prepend(newTaskElement);
  }
  return newTaskElement;
};

/**
 * Remove task object from DOM
 * @param {Task} taskToRemove - task to be removed
 * @return {HTMLElement} - task element removed from DOM
 */
const removeTaskFromDom = (taskToRemove) => {
  const { taskElement } = getTask(taskToRemove);
  taskElement.remove();
  return taskElement;
};

/**
 * Update existing task
 * @param {Task} prevTask - task to be updated
 * @param {Task} nextTask - updated task
 * @return {Task} - updated task
 */
const updateTask = (prevTask, nextTask) => {
  const { taskIndex, taskElement } = getTask(prevTask);

  // update localStorage
  tasks[taskIndex] = nextTask;
  saveTasks();

  // update task in dom
  Object.getOwnPropertyNames(nextTask).forEach((key) => {
    taskElement[key] = nextTask[key];
  });
  return nextTask;
};

/**
 * Deleting existing task
 * @param {Task} taskToDelete - task to be deleted
 */
const deleteTask = (taskToDelete) => {
  // update localStorage
  const { taskIndex } = getTask(taskToDelete);
  tasks.splice(taskIndex, 1);
  window.localStorage.setItem('tasks', JSON.stringify(tasks));
  removeTaskFromDom(taskToDelete);
};

/**
 * Get currently selected task
 */
const getCurrentlySelectedTask = () => tasks.find((t) => t.selected);

/**
 * Select a task
 * @param {Task} task - task to be selected
 * @return {Task} - selected task
 */
const selectTask = (task) => {
  const prevSelectedTask = getCurrentlySelectedTask();
  if (prevSelectedTask) {
    updateTask(prevSelectedTask, { ...prevSelectedTask, selected: false });
  }

  const { taskElement, taskIndex } = getTask(task);
  // move task to front of DOM list
  removeTaskFromDom(task);
  addTaskToDom(taskElement, 'start');

  // move task to front of tasks array
  tasks.splice(taskIndex, 1);
  tasks.unshift(task);

  // update selected property of task
  return updateTask(task, { ...task, selected: true });
};

/**
 * Create a task element from a task object
 * @param {Task} newTask - task to be created
 */
const createTaskElement = (newTask) => {
  const {
    name,
    usedPomodoros,
    estimatedPomodoros,
    selected,
    completed,
  } = newTask;

  // create html element
  const newTaskElement = createElement('task-item', {
    name,
    usedPomodoros,
    estimatedPomodoros,
    selected,
  });

  // add event listeners
  const textContainer = newTaskElement.shadowRoot.querySelector(
    '.text-container',
  );
  const { delete: deleteButton } = getTaskItemButtons(newTaskElement);
  if (!completed) {
    textContainer.onclick = () => selectTask(newTask);
  }
  deleteButton.onclick = () => deleteTask(newTask);
  return newTaskElement;
};

/**
 * Add new task to localStorage, append to DOM
 * @param {Task} newTask - new task to be added
 */
const addTask = (newTask) => {
  // update localStorage
  const newTaskElement = createTaskElement(newTask);
  const indexOfFirstCompleted = tasks.findIndex((t) => t.completed);
  if (indexOfFirstCompleted !== -1) {
    tasks.splice(indexOfFirstCompleted, 0, newTask);
    addTaskToDom(newTaskElement, tasks[indexOfFirstCompleted + 1]);
  } else {
    tasks.push(newTask);
    addTaskToDom(newTaskElement);
  }
  saveTasks();
};

/**
 * Get tasklist
 * @return {Task[]} - current list of tasks
 */
const getTasks = () => {
  return tasks;
};

/**
 * Handle form submission, validate input
 * @param {Event} e - submit event
 */
const handleTaskFormSubmit = (e) => {
  e.preventDefault(); // prevent page reload

  const { name: nameInput, pomodoro: pomodoroInput } = taskItemFormInputs;
  const { value: name } = nameInput;
  const { value: pomodoro } = pomodoroInput;

  const trimmedName = name.trim();
  const pomodoroNumber = Number(pomodoro);

  nameInput.focus();

  addTask({
    name: trimmedName,
    estimatedPomodoros: pomodoroNumber,
    usedPomodoros: 0,
    selected: false,
    completed: false,
  });
  Object.values(taskItemFormInputs).forEach((input) => {
    input.value = '';
  });
};

/**
 * Retrieve tasks from localStorage
 */
const restoreTasks = () => {
  let restoredTasks;
  try {
    restoredTasks = JSON.parse(window.localStorage.getItem('tasks'));
  } catch (e) {
    restoredTasks = null;
  }
  if (!restoredTasks) {
    window.localStorage.setItem('tasks', JSON.stringify([]));
    restoredTasks = [];
  }

  restoredTasks = restoredTasks.filter(validateTask);
  tasks = restoredTasks;
  tasks.forEach((task) => addTaskToDom(createTaskElement(task)));
};

/**
 * Checks if task input is already in list
 * Sets error message for form
 * @param {InputEvent} e - input change from task item form
 */
const checkDuplicateTask = (e) => {
  const { value } = e.target;
  const trimmedName = value.trim();
  if (tasks.some((task) => task.name === trimmedName)) {
    e.target.setCustomValidity('Duplicate task.');
  } else {
    e.target.setCustomValidity('');
  }
};

/**
 * Increment the usedPomodoros for one task
 * @param {Task} task - task to be incremented
 * @return {Task} - incremented task
 */
const incrementPomodoro = (task) => {
  const { usedPomodoros } = task;
  return updateTask(task, { ...task, usedPomodoros: usedPomodoros + 1 });
};

/**
 * Automatically select first task in the task list
 * @return {Task | null} returns first available task, if there are none, return null
 */
const selectFirstTask = () => {
  if (tasks.length > 0 &amp;&amp; !tasks[0].completed) {
    return selectTask(tasks[0]);
  }
  return null;
};

/**
 * Deselect all tasks
 */
const deselectAllTasks = () => {
  tasks.forEach((task) => {
    updateTask(task, { ...task, selected: false });
  });
};

/**
 * Disable task list
 * @param {boolean} shouldTasklistBeUsable - whether task list should be usable
 */
const setTasklistUsability = (shouldTasklistBeUsable) => {
  tasks.forEach((task) => {
    const { taskElement } = getTask(task);
    const { shadowRoot } = taskElement;
    const itemContainer = shadowRoot.querySelector('.item-container');
    const textContainer = shadowRoot.querySelector('.text-container');

    // disable item container
    if (shouldTasklistBeUsable) {
      itemContainer.classList.remove('disabled');
    } else {
      itemContainer.classList.add('disabled');
    }

    // disable select task listener
    if (shouldTasklistBeUsable &amp;&amp; !task.completed) {
      textContainer.onclick = () => selectTask(task);
    } else {
      textContainer.onclick = null;
    }

    // disable buttons
    const buttons = getTaskItemButtons(taskElement);
    Object.values(buttons).forEach((btn) => {
      btn.disabled = !shouldTasklistBeUsable;
    });
  });
};

/**
 * Mark task as complete
 * @param {Task} completedTask - task that has been completed
 */
const completeTask = (completedTask) => {
  const { taskIndex, taskElement } = getTask(completedTask);

  // mark task as completed and move it to end of DOM list
  removeTaskFromDom(completedTask);
  addTaskToDom(taskElement, 'end');
  taskElement.selected = false;
  taskElement.completed = true;
  taskElement.shadowRoot.querySelector('.text-container').onclick = null;

  // move task to end of tasks array
  const [removedTask] = tasks.splice(taskIndex, 1);
  tasks.push({ ...removedTask, selected: false, completed: true });

  // update selected property of task
  updateTask(completedTask, {
    ...removedTask,
    selected: false,
    completed: true,
  });
};

/**
 * Initialize element variables for different elements of task list
 * @param {HTMLElement} root - tasklist element
 */
const initializeElements = (root) => {
  taskList = root;
  taskListContainer = taskList.shadowRoot.querySelector('.container');
  taskListItemContainer = taskListContainer.querySelector(
    '.task-item-container',
  );
  taskItemForm = taskListContainer.querySelector('.task-item-form');
  taskItemFormContainer = taskItemForm.shadowRoot.querySelector('.task-form');
  taskItemFormInputs = {
    name: taskItemFormContainer.querySelector('#name-input'),
    pomodoro: taskItemFormContainer.querySelector('#pomodoro-input'),
  };
};

/**
 * Initialize task list, add event listeners, restore saved tasks
 * @param {HTMLElement} root - task list element
 */
const initializeTaskList = (root) => {
  initializeElements(root);
  taskItemFormContainer.addEventListener('submit', handleTaskFormSubmit);
  restoreTasks();
  taskItemFormInputs.name.oninput = checkDuplicateTask;
};

export {
  initializeTaskList,
  addTask,
  getTasks,
  updateTask,
  deleteTask,
  incrementPomodoro,
  selectTask,
  selectFirstTask,
  deselectAllTasks,
  getCurrentlySelectedTask,
  setTasklistUsability,
  completeTask,
  handleTaskFormSubmit,
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="PomodoroCircles.html">PomodoroCircles</a></li><li><a href="ProgressRing.html">ProgressRing</a></li><li><a href="Settings.html">Settings</a></li><li><a href="TaskItem.html">TaskItem</a></li><li><a href="TaskItemForm.html">TaskItemForm</a></li><li><a href="TaskList.html">TaskList</a></li><li><a href="Timer.html">Timer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addTask">addTask</a></li><li><a href="global.html#addTaskToDom">addTaskToDom</a></li><li><a href="global.html#checkDuplicateTask">checkDuplicateTask</a></li><li><a href="global.html#closePopup">closePopup</a></li><li><a href="global.html#completeTask">completeTask</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#createTaskElement">createTaskElement</a></li><li><a href="global.html#createTaskSummary">createTaskSummary</a></li><li><a href="global.html#createTaskSummaryList">createTaskSummaryList</a></li><li><a href="global.html#deleteTask">deleteTask</a></li><li><a href="global.html#deselectAllTasks">deselectAllTasks</a></li><li><a href="global.html#endSession">endSession</a></li><li><a href="global.html#getCircleCount">getCircleCount</a></li><li><a href="global.html#getCurrentlySelectedTask">getCurrentlySelectedTask</a></li><li><a href="global.html#getLongBreakLength">getLongBreakLength</a></li><li><a href="global.html#getMinutesAndSeconds">getMinutesAndSeconds</a></li><li><a href="global.html#getProgress">getProgress</a></li><li><a href="global.html#getRadius">getRadius</a></li><li><a href="global.html#getShortBreakLength">getShortBreakLength</a></li><li><a href="global.html#getStroke">getStroke</a></li><li><a href="global.html#getTask">getTask</a></li><li><a href="global.html#getTaskItemButtons">getTaskItemButtons</a></li><li><a href="global.html#getTasks">getTasks</a></li><li><a href="global.html#getTime">getTime</a></li><li><a href="global.html#getTimerAudio">getTimerAudio</a></li><li><a href="global.html#handleTaskFormSubmit">handleTaskFormSubmit</a></li><li><a href="global.html#incrementPomodoro">incrementPomodoro</a></li><li><a href="global.html#initializeAnnouncement">initializeAnnouncement</a></li><li><a href="global.html#initializeElements">initializeElements</a></li><li><a href="global.html#initializeIntervalLengths">initializeIntervalLengths</a></li><li><a href="global.html#initializePomodoroCircles">initializePomodoroCircles</a></li><li><a href="global.html#initializePopup">initializePopup</a></li><li><a href="global.html#initializeProgressRing">initializeProgressRing</a></li><li><a href="global.html#initializeTaskList">initializeTaskList</a></li><li><a href="global.html#initializeTimer">initializeTimer</a></li><li><a href="global.html#openPopup">openPopup</a></li><li><a href="global.html#removeTaskFromDom">removeTaskFromDom</a></li><li><a href="global.html#restoreTasks">restoreTasks</a></li><li><a href="global.html#saveSettings">saveSettings</a></li><li><a href="global.html#saveTasks">saveTasks</a></li><li><a href="global.html#selectFirstTask">selectFirstTask</a></li><li><a href="global.html#selectTask">selectTask</a></li><li><a href="global.html#setAnnouncement">setAnnouncement</a></li><li><a href="global.html#setButtonVisibility">setButtonVisibility</a></li><li><a href="global.html#setCircleCount">setCircleCount</a></li><li><a href="global.html#setLongBreakLength">setLongBreakLength</a></li><li><a href="global.html#setNoButtonCallback">setNoButtonCallback</a></li><li><a href="global.html#setProgress">setProgress</a></li><li><a href="global.html#setRadius">setRadius</a></li><li><a href="global.html#setShortBreakLength">setShortBreakLength</a></li><li><a href="global.html#setStroke">setStroke</a></li><li><a href="global.html#setTasklistUsability">setTasklistUsability</a></li><li><a href="global.html#setTimer">setTimer</a></li><li><a href="global.html#setTimerAudio">setTimerAudio</a></li><li><a href="global.html#setYesButtonCallback">setYesButtonCallback</a></li><li><a href="global.html#startInterval">startInterval</a></li><li><a href="global.html#startSession">startSession</a></li><li><a href="global.html#tick">tick</a></li><li><a href="global.html#updateTask">updateTask</a></li><li><a href="global.html#validateBoolean">validateBoolean</a></li><li><a href="global.html#validateCircleCount">validateCircleCount</a></li><li><a href="global.html#validateContainerRadius">validateContainerRadius</a></li><li><a href="global.html#validateLength">validateLength</a></li><li><a href="global.html#validateLongBreakLength">validateLongBreakLength</a></li><li><a href="global.html#validateNumber">validateNumber</a></li><li><a href="global.html#validatePomodoro">validatePomodoro</a></li><li><a href="global.html#validateProgress">validateProgress</a></li><li><a href="global.html#validateShortBreakLength">validateShortBreakLength</a></li><li><a href="global.html#validateString">validateString</a></li><li><a href="global.html#validateTask">validateTask</a></li><li><a href="global.html#validateTime">validateTime</a></li><li><a href="global.html#validateTimerAudio">validateTimerAudio</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Wed Mar 17 2021 00:23:45 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
