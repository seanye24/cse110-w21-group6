<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: scripts/controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: scripts/controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable no-await-in-loop */
import { dispatch, subscribe } from '../models';
import { ACTIONS, INTERVALS } from '../utils/constants';
import { tick, updateClassesByInterval } from '../utils/helpers';
import { openPopup as openConfirmationPopup } from './confirmationPopup';
import { openPopup as openSettingsPopup } from './settings';
import {
  initializePopup as initializeSummaryPopup,
  openPopup as openSummaryPopup,
} from './summaryPopup';
import { getTasks } from './taskList';

let session;
let totalSessionTime;
let numberOfPomodorosCompleted;
let currentTime;
let currentInterval;
let currentSelectedTask;
let pomodoroLength;
let shortBreakLength;
let longBreakLength;
let timerAudio;
let wasAnnouncementButtonClicked;

/**
 * Starts and runs interval until interval is completed
 * @param {number} intervalLength - length of interval (in seconds)
 * @return {Promise&lt;void>} - implicitly returns Promise after currentTime reaches 0
 */
const startInterval = async (intervalLength) => {
  dispatch(ACTIONS.changeCurrentTime, intervalLength);
  while (currentTime >= 0) {
    // quit if session stops
    if (session === 'inactive') {
      return false;
    }
    await tick(1);
    if (session === 'active') {
      dispatch(ACTIONS.changeCurrentTime, currentTime - 1);
    }
  }
  return true;
};

/**
 * Handles pomodoro app, dispatches actions to components depending on the current interval
 */
const startSession = async () => {
  // continue looping if session has not been ended
  while (session === 'active') {
    if (currentInterval === INTERVALS.pomodoro) {
      // stop if no tasks available
      if (!currentSelectedTask) {
        dispatch(ACTIONS.changeSession, 'inactive');
        return;
      }

      // start pomodoro, stop if interval is interrupted
      const shouldContinue = await startInterval(60 * pomodoroLength);
      if (!shouldContinue) {
        return;
      }

      dispatch(ACTIONS.incrementSelectedTask);
      dispatch(ACTIONS.changeNumberOfPomodoros, numberOfPomodorosCompleted + 1);
      dispatch(
        ACTIONS.changeTotalSessionTime,
        totalSessionTime + 60 * pomodoroLength,
      );

      // check if break should be short or long
      const shouldBeLongBreak =
        numberOfPomodorosCompleted > 0 &amp;&amp; numberOfPomodorosCompleted % 4 === 0;
      const nextInterval = shouldBeLongBreak
        ? INTERVALS.longBreak
        : INTERVALS.shortBreak;
      dispatch(ACTIONS.changeCurrentInterval, nextInterval);
    } else {
      wasAnnouncementButtonClicked = false;
      // start break, stop if interval is interrupted
      const nextIntervalLength =
        currentInterval === INTERVALS.longBreak
          ? longBreakLength
          : shortBreakLength;
      const shouldContinue = await startInterval(60 * nextIntervalLength);

      // choose no if user didn't pick
      if (!wasAnnouncementButtonClicked) {
        dispatch(ACTIONS.doNotCompleteSelectedTask);
      }
      if (!shouldContinue) {
        return;
      }

      dispatch(
        ACTIONS.changeTotalSessionTime,
        totalSessionTime + 60 * nextIntervalLength,
      );
      dispatch(ACTIONS.changeCurrentInterval, INTERVALS.pomodoro);
    }
  }
};

/**
 * Handle end of session
 */
const endSession = () => {
  if (numberOfPomodorosCompleted > 0) {
    initializeSummaryPopup(
      document.querySelector('#summary-overlay'),
      getTasks(),
    );
    openSummaryPopup();
  }
  dispatch(ACTIONS.changeTotalSessionTime, 0);
  dispatch(ACTIONS.changeCurrentTime, 0);
  dispatch(ACTIONS.changeCurrentInterval, INTERVALS.pomodoro);
  dispatch(ACTIONS.changeSelectedTask, null);
  dispatch(ACTIONS.changeNumberOfPomodoros, 0);
  dispatch(ACTIONS.clearCompletedTasks);
};

const initializeController = () => {
  const mainElement = document.querySelector('#main');
  const navBarElement = document.querySelector('.navbar');
  const footerElement = document.querySelector('.footer');
  const sessionButton = document.querySelector('.session-button');
  const settingsIcon = document.querySelector('.material-icons');
  const progressRingElement = document.querySelector('.progress-ring');
  const timerElement = progressRingElement.shadowRoot.querySelector('.timer');

  const elementsThatChangeTheme = [
    mainElement,
    navBarElement,
    sessionButton,
    footerElement,
  ];

  const onChangeSession = (sessionState) => {
    session = sessionState.session;
    if (session === 'active') {
      sessionButton.innerText = 'End';
      sessionButton.classList.add('session-button', 'in-session');
    } else if (session === 'inactive') {
      updateClassesByInterval(INTERVALS.pomodoro, elementsThatChangeTheme);
      sessionButton.innerText = 'Start';
      sessionButton.classList.remove('in-session');
      endSession();
    }
  };
  const onChangeTotalSessionTime = (sessionState) => {
    totalSessionTime = sessionState.totalSessionTime;
  };
  const onChangeTime = (sessionState) => {
    currentTime = sessionState.currentTime;
  };
  const onChangeInterval = (sessionState) => {
    currentInterval = sessionState.currentInterval;
    updateClassesByInterval(currentInterval, elementsThatChangeTheme);

    // play timer audio at the end of every interval
    if (
      sessionState.session === 'active' &amp;&amp;
      sessionState.numberOfPomodorosCompleted > 0
    ) {
      timerAudio.pause();
      timerAudio.play().catch(() => true); // ignore if interrupted
    }
  };
  const onSelectTask = (sessionState) => {
    currentSelectedTask = sessionState.currentSelectedTask;
  };
  const onChangeNumPomodoros = (sessionState) => {
    numberOfPomodorosCompleted = sessionState.numberOfPomodorosCompleted;
  };
  const onChangePomodoroLength = (sessionState) => {
    pomodoroLength = sessionState.pomodoroLength;
  };
  const onChangeShortBreakLength = (sessionState) => {
    shortBreakLength = sessionState.shortBreakLength;
  };
  const onChangeLongBreakLength = (sessionState) => {
    longBreakLength = sessionState.longBreakLength;
  };
  const onChangeTimerAudio = (sessionState) => {
    timerAudio = sessionState.timerAudio;
  };
  const onCompleteTask = () => {
    wasAnnouncementButtonClicked = true;
  };
  const onDidNotCompleteTask = () => {
    wasAnnouncementButtonClicked = true;
  };

  ({
    session,
    totalSessionTime,
    numberOfPomodorosCompleted,
    currentTime,
    currentInterval,
    currentSelectedTask,
    pomodoroLength,
    shortBreakLength,
    longBreakLength,
    timerAudio,
  } = subscribe({
    [ACTIONS.changeSession]: onChangeSession,
    [ACTIONS.changeTotalSessionTime]: onChangeTotalSessionTime,
    [ACTIONS.changeNumberOfPomodoros]: onChangeNumPomodoros,
    [ACTIONS.changeCurrentTime]: onChangeTime,
    [ACTIONS.changeCurrentInterval]: onChangeInterval,
    [ACTIONS.changeSelectedTask]: onSelectTask,
    [ACTIONS.changePomodoroLength]: onChangePomodoroLength,
    [ACTIONS.changeShortBreakLength]: onChangeShortBreakLength,
    [ACTIONS.changeLongBreakLength]: onChangeLongBreakLength,
    [ACTIONS.changeTimerAudio]: onChangeTimerAudio,
    [ACTIONS.completeSelectedTask]: onCompleteTask,
    [ACTIONS.doNotCompleteSelectedTask]: onDidNotCompleteTask,
  }));

  // initialize variables, event listeners, and component values
  settingsIcon.onclick = openSettingsPopup;
  timerElement.onclick = () => timerAudio.pause();
  sessionButton.onmousedown = (e) => {
    e.preventDefault();
  };
  [...document.querySelectorAll('.navbar-link')].forEach((l) => {
    l.onmousedown = (e) => e.preventDefault();
  });

  // start session when start button is clicked
  sessionButton.addEventListener('click', async () => {
    if (sessionButton.innerText === 'Start') {
      // enable audio element
      const oldTimerAudioSrc = timerAudio.src;
      timerAudio.src = '';
      timerAudio.play().catch(() => true); // ignore if interrupted
      timerAudio.src = oldTimerAudioSrc;

      dispatch(ACTIONS.changeSession, 'active');
      await startSession();
    } else {
      openConfirmationPopup();
    }
  });
};

export default initializeController;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="PomodoroCircles.html">PomodoroCircles</a></li><li><a href="ProgressRing.html">ProgressRing</a></li><li><a href="Settings.html">Settings</a></li><li><a href="TaskItem.html">TaskItem</a></li><li><a href="TaskItemForm.html">TaskItemForm</a></li><li><a href="TaskList.html">TaskList</a></li><li><a href="Timer.html">Timer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addTask">addTask</a></li><li><a href="global.html#addTaskToDom">addTaskToDom</a></li><li><a href="global.html#checkDuplicateTask">checkDuplicateTask</a></li><li><a href="global.html#closePopup">closePopup</a></li><li><a href="global.html#completeTask">completeTask</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#createTaskElement">createTaskElement</a></li><li><a href="global.html#createTaskSummary">createTaskSummary</a></li><li><a href="global.html#createTaskSummaryList">createTaskSummaryList</a></li><li><a href="global.html#deleteTask">deleteTask</a></li><li><a href="global.html#deselectAllTasks">deselectAllTasks</a></li><li><a href="global.html#disableTask">disableTask</a></li><li><a href="global.html#dispatch">dispatch</a></li><li><a href="global.html#endSession">endSession</a></li><li><a href="global.html#getCircleCount">getCircleCount</a></li><li><a href="global.html#getCurrentSelectedTask">getCurrentSelectedTask</a></li><li><a href="global.html#getHoursMinutesAndSeconds">getHoursMinutesAndSeconds</a></li><li><a href="global.html#getLongBreakLength">getLongBreakLength</a></li><li><a href="global.html#getMinutesAndSeconds">getMinutesAndSeconds</a></li><li><a href="global.html#getProgress">getProgress</a></li><li><a href="global.html#getRadius">getRadius</a></li><li><a href="global.html#getShortBreakLength">getShortBreakLength</a></li><li><a href="global.html#getStroke">getStroke</a></li><li><a href="global.html#getTask">getTask</a></li><li><a href="global.html#getTaskItemButtons">getTaskItemButtons</a></li><li><a href="global.html#getTasks">getTasks</a></li><li><a href="global.html#getTime">getTime</a></li><li><a href="global.html#getTimerAudio">getTimerAudio</a></li><li><a href="global.html#getTotalSessionTime">getTotalSessionTime</a></li><li><a href="global.html#handleTaskFormSubmit">handleTaskFormSubmit</a></li><li><a href="global.html#incrementTask">incrementTask</a></li><li><a href="global.html#initializeAnnouncement">initializeAnnouncement</a></li><li><a href="global.html#initializeElements">initializeElements</a></li><li><a href="global.html#initializeIntervalLengths">initializeIntervalLengths</a></li><li><a href="global.html#initializePomodoroCircles">initializePomodoroCircles</a></li><li><a href="global.html#initializePopup">initializePopup</a></li><li><a href="global.html#initializeProgressRing">initializeProgressRing</a></li><li><a href="global.html#initializeTaskList">initializeTaskList</a></li><li><a href="global.html#initializeTimer">initializeTimer</a></li><li><a href="global.html#openPopup">openPopup</a></li><li><a href="global.html#removeTaskFromDom">removeTaskFromDom</a></li><li><a href="global.html#restoreTasks">restoreTasks</a></li><li><a href="global.html#saveSettings">saveSettings</a></li><li><a href="global.html#saveTasks">saveTasks</a></li><li><a href="global.html#selectFirstTask">selectFirstTask</a></li><li><a href="global.html#selectTask">selectTask</a></li><li><a href="global.html#setAnnouncement">setAnnouncement</a></li><li><a href="global.html#setButtonVisibility">setButtonVisibility</a></li><li><a href="global.html#setCircleCount">setCircleCount</a></li><li><a href="global.html#setLongBreakLength">setLongBreakLength</a></li><li><a href="global.html#setProgress">setProgress</a></li><li><a href="global.html#setRadius">setRadius</a></li><li><a href="global.html#setShortBreakLength">setShortBreakLength</a></li><li><a href="global.html#setStroke">setStroke</a></li><li><a href="global.html#setTasklistUsability">setTasklistUsability</a></li><li><a href="global.html#setTimer">setTimer</a></li><li><a href="global.html#setTimerAudio">setTimerAudio</a></li><li><a href="global.html#startInterval">startInterval</a></li><li><a href="global.html#startSession">startSession</a></li><li><a href="global.html#subscribe">subscribe</a></li><li><a href="global.html#tick">tick</a></li><li><a href="global.html#updateClassesByInterval">updateClassesByInterval</a></li><li><a href="global.html#updateTask">updateTask</a></li><li><a href="global.html#validateBoolean">validateBoolean</a></li><li><a href="global.html#validateCircleCount">validateCircleCount</a></li><li><a href="global.html#validateContainerRadius">validateContainerRadius</a></li><li><a href="global.html#validateLength">validateLength</a></li><li><a href="global.html#validateLongBreakLength">validateLongBreakLength</a></li><li><a href="global.html#validateNumber">validateNumber</a></li><li><a href="global.html#validatePomodoro">validatePomodoro</a></li><li><a href="global.html#validateProgress">validateProgress</a></li><li><a href="global.html#validateShortBreakLength">validateShortBreakLength</a></li><li><a href="global.html#validateString">validateString</a></li><li><a href="global.html#validateTask">validateTask</a></li><li><a href="global.html#validateTime">validateTime</a></li><li><a href="global.html#validateTimerAudio">validateTimerAudio</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Fri Mar 19 2021 03:36:35 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
